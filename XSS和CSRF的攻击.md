---
title: XSS和CSRF的攻击
date: 2018-08-30 15:03:41
tags:
---
# XSS和CSRF攻击
### XSS跨站脚本攻击
xss叫做跨站脚本攻击，是一种web应用中的计算机漏洞，当用户浏览器渲染整个HTML文档的过程中出现了不被预期的脚本指令并执行时，XSS就会发生。(这个逼装的好，鼓个掌) 

它指的是恶意攻击者往Web页面里插入恶意html代码，当用户浏览该页之时，嵌入其中Web里面的html代码会被执行，从而达到恶意攻击用户的特殊目的。

### XSS 分为三种
```base
反射型XSS : 这种xss，跨站代码一般存在于某一个链接中，当被攻击者访问这样的连接时，跨站代码就被执行，这类跨站代码一般不会存储在服务器上面
```
```base
存储型XSS : 这种xss用起来比较方便，跨站代码会存储在服务器上面数据库中，换句话就是可以持久的进行攻击，亦称持久型XSS
```
```基于DOM的XSS
基于DOM的XSS : 这是由于客户端脚本自身的解析不正确导致的安全问题
```
### 如何攻击 ？
XSS 通过修改 HTML 节点或者执行 JS 代码来攻击网站。
```javascript
    // 比如在一个留言板中插入xss代码，前提是留言内容不过滤
    
    // 在文本框中添加
    <script>alert('我是XSS攻击')</script>

    // 这时候点击留言，脚本被执行，就会弹出对话框，这就说明存在XSS危害
```
### 如何预防 ？
最普遍的做法是转义输入输出的内容，对于引号，尖括号，斜杠进行转义
```javascript
    function escape(str) {
        str = str.replace(/&/g, "&amp;");
        str = str.replace(/</g, "&lt;");
        str = str.replace(/>/g, "&gt;");
        str = str.replace(/"/g, "&quto;");
        str = str.replace(/'/g, "&##39;");
        str = str.replace(/`/g, "&##96;");
        str = str.replace(/\//g, "&##x2F;");
        return str
    }

    // 通过转义，将攻击代码变成
    escape('<script>alert(1)</script>')
    // &lt;script&gt;alert(1)&lt;&##x2F;script&gt;
```
--------
### CSRF跨站请求伪造
你可以这样理解 : 攻击者盗用了你的身份，以你的名义发送恶意请求，对服务器来说这个请求是完全合法的，但是却完成了攻击者所期望的一个操作，比如以你的名义发送邮件、发消息，盗取你的账号，添加系统管理员，甚至于购买商品、虚拟货币转账等。 
<!-- more -->
#### 我们是实在人，举个实在例子
受害者 A 在银行有一笔存款，通过对银行的网站发送请求 http://bank.example/withdraw?account=A&amount=1000000&for=B 可以使 A 把 1000000 的存款转到 B 的账号下。

通常情况下，该请求发送到网站后，服务器会先验证该请求是否来自一个合法的 session，并且该 session 的用户 Bob 已经成功登陆。

黑客 B 自己在该银行也有账户，他知道上文中的 URL 可以把钱进行转帐操作。Mallory 可以自己发送一个请求给银行：http://bank.example/withdraw?account=A&amount=1000000&for=B。但是这个请求来自 B 而非 A，他不能通过安全认证，因此该请求不会起作用。

这时，B 想到使用 CSRF 的攻击方式，他先自己做一个网站，在网站中放入如下代码： src=”http://bank.example/withdraw?account=A&amount=1000000&for=B ”，并且通过广告等诱使 A 来访问他的网站。

当 A 访问该网站时，上述 url 就会从 A 的浏览器发向银行，而这个请求会附带 A 浏览器中的 cookie 一起发向银行服务器。大多数情况下，该请求会失败，因为他要求 A 的认证信息。

但是！！！如果 A 当时恰巧刚访问他的银行后不久，他的浏览器与银行网站之间的 session 尚未过期，浏览器的 cookie 之中含有 A 的认证信息。这时，悲剧发生了，这个 url 请求就会得到响应，钱将从 A 的账号转移到 B 的账号，而 A 当时毫不知情。

等以后 A 发现账户钱少了，即使他去银行查询日志，他也只能发现确实有一个来自于他本人的合法请求转移了资金，没有任何被攻击的痕迹。而 B 则可以拿到钱后逍遥法外。 

#### 如何防御
```base
    1 、 验证 HTTP Referer 字段；Referer 来判断该请求是否为第三方网站发起的
    
    2 、 在请求地址中添加 token 并验证；由服务器下发一个随机 Token（算法不能复杂），每次发起请求时将 Token 携带上，服务器验证 Token 是否有效。
    
    3 、 在 HTTP 头中自定义属性并验证。可以对 Cookie 设置 SameSite 属性。该属性设置 Cookie 不随着跨域请求发送，该属性可以很大程度减少 CSRF 的攻击
```

### 知乎生动解释
```javascript
    马三立小品〈逗你玩〉中的小偷就利用xss突破了防盗系统

    防盗系统启动:
    妈妈：给我看着衣服
    小孩：好的
    
    (小偷来....)
    
    正常工作情况下：
    小孩：你是谁？
    小偷：我叫张三
    小孩：妈妈，有人偷衣服
    妈妈：谁？
    小孩：张三
    小偷被捉
    
    漏洞情况下：
    小孩：你是谁？
    小偷：我叫逗你玩
    小孩：妈妈，有人偷衣服
    妈妈：谁？
    小孩：逗你玩 
    妈妈：。。。
    
    CSRF攻击是让用户在不知情的情况，冒用其身份发起了一个请求
    小偷：你妈妈喊你去买洗衣粉

```

## 相关链接
知乎例子 李上天 : https://www.zhihu.com/question/34445731/answer/86381916

互联网协议入门（一）：http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html

个人简历 : http://www.pengdaokuan.cn

个人博客 : http://blog.pengdaokuan.cn:4001

